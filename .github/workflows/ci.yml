name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

jobs:
  backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: cbn_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      SECRET_KEY: abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234
      DEBUG: "False"
      ALLOWED_HOSTS: localhost,127.0.0.1
      POSTGRES_DB: cbn_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_HOST: 127.0.0.1
      POSTGRES_PORT: 5432
      CORS_ALLOWED_ORIGINS: https://example.com
      CSRF_TRUSTED_ORIGINS: https://example.com
      JWT_ISSUER: http://localhost:8080/realms/cbn
      JWT_JWK_URL: http://localhost:8080/realms/cbn/protocol/openid-connect/certs
      REDIS_URL: redis://127.0.0.1:6379/0
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Migrate database
        run: python manage.py migrate --noinput

      - name: Django deploy check
        run: python manage.py check --deploy

      - name: Run tests with coverage
        run: pytest --cov

      - name: Ruff lint
        run: ruff check core content accounts media_app navigation home homeNews painelControle conftest.py manage.py

      - name: Ruff format check
        run: ruff format --check core content accounts media_app navigation home homeNews painelControle conftest.py manage.py

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci

      - name: Frontend lint
        run: npm run lint

      - name: Frontend tests
        run: npm run test

      - name: Frontend build
        env:
          NEXT_TELEMETRY_DISABLED: '1'
          AUTH_SECRET: ci-build-secret
          AUTH_KEYCLOAK_ID: cbn-frontend
          AUTH_KEYCLOAK_SECRET: ci-build-secret
          AUTH_KEYCLOAK_ISSUER: http://localhost:8080/realms/cbn
        run: npm run build

  security:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        working-directory: .
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: pip-audit
        working-directory: .
        run: pip-audit

      - name: Install frontend dependencies
        run: npm ci

      - name: npm audit
        run: npm audit --audit-level=high
